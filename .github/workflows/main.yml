name: CI/CD - Deploy para AWS

on:
  push:
    branches:
      - main
    paths:
      - 'projeto/backend/**'
      - 'projeto/frontend/**'
      - '.github/workflows/deploy.yml'
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Detectar mudanÃ§as
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            backend:
              - 'projeto/backend/**'
            frontend:
              - 'projeto/frontend/**'

  test-and-deploy-backend:
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./projeto/backend
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # ------------------------------
      # ðŸ” SONARCLOUD - INTEGRADO AQUI
      # ------------------------------

      - name: Cache SonarCloud
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: AnÃ¡lise SonarCloud
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.projectKey=leojec_plataforma-clientes

      # ------------------------------
      # ðŸ”½ ContinuaÃ§Ã£o normal do CI/CD
      # ------------------------------

      - name: Compilar e rodar testes
        run: |
          mvn clean compile test
      
      - name: Gerar relatÃ³rio de cobertura
        run: |
          mvn jacoco:report
          echo "ðŸ“Š RelatÃ³rio de cobertura gerado com sucesso!"
      
      - name: Upload relatÃ³rio de cobertura
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-backend
          path: projeto/backend/target/site/jacoco/**
          retention-days: 30
      
      - name: Build do JAR
        run: |
          mvn clean package -DskipTests
      
      - name: Verificar JAR gerado
        run: |
          if [ ! -f "target/crmshot-backend-0.0.1-SNAPSHOT.jar" ]; then
            echo "âŒ Erro: JAR nÃ£o foi gerado!"
            exit 1
          fi
          echo "âœ… JAR gerado com sucesso!"
          ls -lh target/crmshot-backend-0.0.1-SNAPSHOT.jar
      
      - name: Configurar credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2
      
      - name: Preparar arquivos para deploy
        run: |
          VERSION_LABEL="v$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA:0:7}"
          echo "VERSION_LABEL=$VERSION_LABEL" >> $GITHUB_ENV
          
          mkdir -p deploy-package
          cp target/crmshot-backend-0.0.1-SNAPSHOT.jar deploy-package/
          cp -r .ebextensions deploy-package/ 2>/dev/null || true
          
          # O Procfile jÃ¡ estÃ¡ no diretÃ³rio backend (working-directory)
          if [ -f Procfile ]; then
            cp Procfile deploy-package/
            echo "âœ… Procfile copiado para deploy-package/"
            cat Procfile
          else
            echo "âŒ ERRO: Procfile nÃ£o encontrado!"
            echo "Procurando Procfile..."
            find .. -name "Procfile" -type f 2>/dev/null || echo "Procfile nÃ£o encontrado em lugar nenhum"
            exit 1
          fi
          
          cd deploy-package
          zip -r ../deploy-backend.zip .
          cd ..
          ls -la deploy-package/
      
      - name: Upload pacote para S3
        run: |
          aws s3 cp deploy-backend.zip \
            s3://${{ secrets.S3_BUCKET_BACKEND }}/deploy-backend-${{ env.VERSION_LABEL }}.zip
      
      - name: Verificar se aplicaÃ§Ã£o existe no Elastic Beanstalk
        run: |
          aws elasticbeanstalk describe-applications \
            --application-names ${{ secrets.EB_APPLICATION_NAME }} \
            --region us-east-2
      
      - name: Criar versÃ£o da aplicaÃ§Ã£o no Elastic Beanstalk
        run: |
          aws elasticbeanstalk create-application-version \
            --application-name ${{ secrets.EB_APPLICATION_NAME }} \
            --version-label "${{ env.VERSION_LABEL }}" \
            --source-bundle S3Bucket=${{ secrets.S3_BUCKET_BACKEND }},S3Key=deploy-backend-${{ env.VERSION_LABEL }}.zip \
            --description "Deploy automÃ¡tico via GitHub Actions - Commit: ${GITHUB_SHA}" \
            --region us-east-2
      
      - name: Atualizar ambiente do Elastic Beanstalk
        run: |
          aws elasticbeanstalk update-environment \
            --application-name ${{ secrets.EB_APPLICATION_NAME }} \
            --environment-name ${{ secrets.EB_ENVIRONMENT_NAME }} \
            --version-label "${{ env.VERSION_LABEL }}" \
            --region us-east-2
      
      - name: Aguardar atualizaÃ§Ã£o do ambiente
        run: |
          aws elasticbeanstalk wait environment-updated \
            --environment-name ${{ secrets.EB_ENVIRONMENT_NAME }} \
            --region us-east-2 || true
      
      - name: Verificar status do deploy
        run: |
          STATUS=$(aws elasticbeanstalk describe-environments \
            --environment-names ${{ secrets.EB_ENVIRONMENT_NAME }} \
            --region us-east-2 \
            --query 'Environments[0].Status' \
            --output text)
          
          HEALTH=$(aws elasticbeanstalk describe-environments \
            --environment-names ${{ secrets.EB_ENVIRONMENT_NAME }} \
            --region us-east-2 \
            --query 'Environments[0].Health' \
            --output text)
          
          echo "Status: $STATUS"
          echo "Health: $HEALTH"

  build-and-deploy-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./projeto/frontend
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ./projeto/frontend/package-lock.json
      
      - name: Instalar dependÃªncias
        run: npm ci
      
      - name: Rodar testes (se existirem)
        run: npm test -- --watchAll=false --coverage --passWithNoTests
        continue-on-error: true
      
      - name: Configurar credenciais AWS (para obter URL do CloudFront)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2
      
      - name: Obter URL do CloudFront
        id: get-cloudfront-url
        run: |
          if [ -z "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
            echo "âš ï¸ CLOUDFRONT_DISTRIBUTION_ID nÃ£o configurado, usando REACT_APP_API_URL do secret"
            echo "CLOUDFRONT_URL=${{ secrets.REACT_APP_API_URL }}" >> $GITHUB_ENV
          else
            CLOUDFRONT_URL=$(aws cloudfront get-distribution \
              --id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
              --query 'Distribution.DomainName' \
              --output text)
            
            if [ -z "$CLOUDFRONT_URL" ] || [ "$CLOUDFRONT_URL" == "None" ]; then
              echo "âš ï¸ NÃ£o foi possÃ­vel obter URL do CloudFront, usando REACT_APP_API_URL do secret"
              echo "CLOUDFRONT_URL=${{ secrets.REACT_APP_API_URL }}" >> $GITHUB_ENV
            else
              # CloudFront com HTTPS (sem /api, pois o api.js jÃ¡ adiciona)
              CLOUDFRONT_URL="https://${CLOUDFRONT_URL}"
              echo "âœ… URL do CloudFront (backend proxy): $CLOUDFRONT_URL"
              echo "CLOUDFRONT_URL=$CLOUDFRONT_URL" >> $GITHUB_ENV
            fi
          fi
      
      - name: Build do frontend
        env:
          REACT_APP_API_URL: ${{ env.CLOUDFRONT_URL || secrets.REACT_APP_API_URL }}
        run: |
          if [ -z "$REACT_APP_API_URL" ]; then
            echo "âŒ ERRO: REACT_APP_API_URL nÃ£o estÃ¡ configurado!"
            echo "Configure o secret REACT_APP_API_URL no GitHub com a URL do CloudFront (ex: https://d1234567890.cloudfront.net/api)"
            exit 1
          fi
          echo "ðŸ”§ Usando REACT_APP_API_URL: $REACT_APP_API_URL"
          npm run build
      
      - name: Verificar build gerado
        run: |
          if [ ! -d "build" ]; then exit 1; fi
      
      - name: Sincronizar arquivos para S3
        run: |
          aws s3 sync build/ \
            s3://${{ secrets.S3_BUCKET_FRONTEND }}/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html" \
            --exclude "service-worker.js"
      
      - name: Upload arquivos HTML com cache curto
        run: |
          aws s3 sync build/ \
            s3://${{ secrets.S3_BUCKET_FRONTEND }}/ \
            --cache-control "public, max-age=0, must-revalidate" \
            --exclude "*" \
            --include "*.html" \
            --include "service-worker.js"
      
      - name: Invalidar cache do CloudFront
        env:
          CLOUDFRONT_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
        run: |
          if [ ! -z "$CLOUDFRONT_ID" ]; then
            aws cloudfront create-invalidation \
              --distribution-id "$CLOUDFRONT_ID" \
              --paths "/*"
          fi

  summary:
    needs: [detect-changes, test-and-deploy-backend, build-and-deploy-frontend]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Resumo do deploy
        run: |
          echo "## ðŸ“Š Resumo do Deploy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### MudanÃ§as detectadas:" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${{ needs.detect-changes.outputs.backend }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.detect-changes.outputs.frontend }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status dos deploys:" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${{ needs.test-and-deploy-backend.result || 'nÃ£o executado' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.build-and-deploy-frontend.result || 'nÃ£o executado' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Cobertura de CÃ³digo:" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.test-and-deploy-backend.result }}" == "success" ]; then
            echo "âœ… Backend: RelatÃ³rio de cobertura gerado" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“‹ RelatÃ³rio disponÃ­vel nos artifacts: coverage-report-backend" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Backend: Falha ao gerar relatÃ³rio de cobertura" >> $GITHUB_STEP_SUMMARY
          fi
