<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ChatController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">crmshot-backend</a> &gt; <a href="index.source.html" class="el_package">com.crmshot.controller</a> &gt; <span class="el_source">ChatController.java</span></div><h1>ChatController.java</h1><pre class="source lang-java linenums">package com.crmshot.controller;

import com.crmshot.entity.Interacao;
import com.crmshot.entity.Expositor;
import com.crmshot.repository.InteracaoRepository;
import com.crmshot.repository.ExpositorRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;
import java.util.stream.Collectors;

@RestController
@RequestMapping(&quot;/api/chat&quot;)
@CrossOrigin(origins = &quot;*&quot;)
<span class="nc" id="L19">public class ChatController {</span>

    @Autowired
    private InteracaoRepository interacaoRepository;

    @Autowired
    private ExpositorRepository expositorRepository;

    @PostMapping(&quot;/perguntar&quot;)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; processarPergunta(@RequestBody Map&lt;String, String&gt; request) {
<span class="nc" id="L29">        String pergunta = request.get(&quot;pergunta&quot;).toLowerCase();</span>
        String resposta;

        try {
            // Processar pergunta e gerar resposta
<span class="nc bnc" id="L34" title="All 4 branches missed.">            if (pergunta.contains(&quot;pr√≥xima reuni√£o&quot;) || pergunta.contains(&quot;proxima reuniao&quot;) || </span>
<span class="nc bnc" id="L35" title="All 6 branches missed.">                pergunta.contains(&quot;pr√≥ximo encontro&quot;) || pergunta.contains(&quot;quando&quot;) &amp;&amp; pergunta.contains(&quot;reuni√£o&quot;)) {</span>
<span class="nc" id="L36">                resposta = buscarProximaReuniao();</span>
                
<span class="nc bnc" id="L38" title="All 4 branches missed.">            } else if (pergunta.contains(&quot;quantos leads&quot;) || pergunta.contains(&quot;quantidade de leads&quot;) ||</span>
<span class="nc bnc" id="L39" title="All 4 branches missed.">                       pergunta.contains(&quot;quantos clientes&quot;) || pergunta.contains(&quot;total de leads&quot;)) {</span>
<span class="nc" id="L40">                resposta = contarLeads();</span>
                
<span class="nc bnc" id="L42" title="All 4 branches missed.">            } else if (pergunta.contains(&quot;atividades hoje&quot;) || pergunta.contains(&quot;atividade hoje&quot;) ||</span>
<span class="nc bnc" id="L43" title="All 2 branches missed.">                       pergunta.contains(&quot;o que tenho hoje&quot;)) {</span>
<span class="nc" id="L44">                resposta = buscarAtividadesHoje();</span>
                
<span class="nc bnc" id="L46" title="All 6 branches missed.">            } else if (pergunta.contains(&quot;propostas&quot;) &amp;&amp; (pergunta.contains(&quot;valor&quot;) || pergunta.contains(&quot;quanto&quot;))) {</span>
<span class="nc" id="L47">                resposta = buscarValorPropostas();</span>
                
<span class="nc bnc" id="L49" title="All 4 branches missed.">            } else if (pergunta.contains(&quot;√∫ltima atividade&quot;) || pergunta.contains(&quot;ultima atividade&quot;) ||</span>
<span class="nc bnc" id="L50" title="All 4 branches missed.">                       pergunta.contains(&quot;√∫ltimo contato&quot;) || pergunta.contains(&quot;ultimo contato&quot;)) {</span>
<span class="nc" id="L51">                resposta = buscarUltimaAtividade();</span>
                
<span class="nc bnc" id="L53" title="All 4 branches missed.">            } else if (pergunta.contains(&quot;atividades pendentes&quot;) || pergunta.contains(&quot;atividade pendente&quot;) ||</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">                       pergunta.contains(&quot;tarefas pendentes&quot;)) {</span>
<span class="nc" id="L55">                resposta = buscarAtividadesPendentes();</span>
                
<span class="nc bnc" id="L57" title="All 6 branches missed.">            } else if (pergunta.contains(&quot;m¬≤&quot;) || pergunta.contains(&quot;metros&quot;) || pergunta.contains(&quot;area vendida&quot;)) {</span>
<span class="nc" id="L58">                resposta = buscarMetrosVendidos();</span>
                
<span class="nc bnc" id="L60" title="All 6 branches missed.">            } else if (pergunta.contains(&quot;resumo&quot;) || pergunta.contains(&quot;overview&quot;) || pergunta.contains(&quot;vis√£o geral&quot;)) {</span>
<span class="nc" id="L61">                resposta = gerarResumo();</span>
                
<span class="nc" id="L63">            } else {</span>
<span class="nc" id="L64">                resposta = &quot;Desculpe, n√£o entendi sua pergunta. Tente perguntar sobre:\n\n&quot; +</span>
                          &quot;‚Ä¢ Pr√≥ximas reuni√µes\n&quot; +
                          &quot;‚Ä¢ Quantidade de leads\n&quot; +
                          &quot;‚Ä¢ Atividades de hoje\n&quot; +
                          &quot;‚Ä¢ Valor de propostas\n&quot; +
                          &quot;‚Ä¢ √öltima atividade\n&quot; +
                          &quot;‚Ä¢ Atividades pendentes\n&quot; +
                          &quot;‚Ä¢ Metros quadrados vendidos\n&quot; +
                          &quot;‚Ä¢ Resumo geral&quot;;
            }

<span class="nc" id="L75">            Map&lt;String, String&gt; response = new HashMap&lt;&gt;();</span>
<span class="nc" id="L76">            response.put(&quot;resposta&quot;, resposta);</span>
<span class="nc" id="L77">            return ResponseEntity.ok(response);</span>

<span class="nc" id="L79">        } catch (Exception e) {</span>
<span class="nc" id="L80">            Map&lt;String, String&gt; errorResponse = new HashMap&lt;&gt;();</span>
<span class="nc" id="L81">            errorResponse.put(&quot;resposta&quot;, &quot;Desculpe, ocorreu um erro ao processar sua pergunta. Tente novamente.&quot;);</span>
<span class="nc" id="L82">            return ResponseEntity.ok(errorResponse);</span>
        }
    }

    private String buscarProximaReuniao() {
<span class="nc" id="L87">        LocalDateTime agora = LocalDateTime.now();</span>
<span class="nc" id="L88">        LocalDateTime limite = agora.plusDays(30);</span>
        
<span class="nc" id="L90">        List&lt;Interacao&gt; proximasInteracoes = interacaoRepository.findProximasAcoes(limite)</span>
<span class="nc" id="L91">                .stream()</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">                .filter(i -&gt; i.getTipo() == Interacao.TipoInteracao.REUNIAO)</span>
<span class="nc" id="L93">                .sorted(Comparator.comparing(Interacao::getDataProximaAcao))</span>
<span class="nc" id="L94">                .collect(Collectors.toList());</span>

<span class="nc bnc" id="L96" title="All 2 branches missed.">        if (proximasInteracoes.isEmpty()) {</span>
<span class="nc" id="L97">            return &quot;Voc√™ n√£o tem reuni√µes agendadas para os pr√≥ximos 30 dias.&quot;;</span>
        }

<span class="nc" id="L100">        Interacao proximaReuniao = proximasInteracoes.get(0);</span>
<span class="nc" id="L101">        DateTimeFormatter formatter = DateTimeFormatter.ofPattern(&quot;dd/MM/yyyy '√†s' HH:mm&quot;);</span>
<span class="nc" id="L102">        String dataFormatada = proximaReuniao.getDataProximaAcao().format(formatter);</span>
        
<span class="nc" id="L104">        return String.format(&quot;Sua pr√≥xima reuni√£o √© no dia %s com %s.\n\nAssunto: %s&quot;,</span>
<span class="nc" id="L105">                dataFormatada,</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                proximaReuniao.getExpositor().getNomeFantasia() != null ? </span>
<span class="nc" id="L107">                    proximaReuniao.getExpositor().getNomeFantasia() : </span>
<span class="nc" id="L108">                    proximaReuniao.getExpositor().getRazaoSocial(),</span>
<span class="nc" id="L109">                proximaReuniao.getAssunto());</span>
    }

    private String contarLeads() {
<span class="nc" id="L113">        long totalLeads = expositorRepository.count();</span>
<span class="nc" id="L114">        long leadsAtivos = expositorRepository.countByStatus(Expositor.StatusExpositor.ATIVO);</span>
<span class="nc" id="L115">        long leadsPotenciais = expositorRepository.countByStatus(Expositor.StatusExpositor.POTENCIAL);</span>
        
<span class="nc" id="L117">        return String.format(&quot;Voc√™ tem um total de %d leads cadastrados:\n\n&quot; +</span>
                           &quot;‚Ä¢ %d leads ativos\n&quot; +
                           &quot;‚Ä¢ %d leads potenciais\n\n&quot; +
                           &quot;Continue prospectando! üí™&quot;,
<span class="nc" id="L121">                           totalLeads, leadsAtivos, leadsPotenciais);</span>
    }

    private String buscarAtividadesHoje() {
<span class="nc" id="L125">        LocalDateTime inicioDia = LocalDateTime.now().withHour(0).withMinute(0).withSecond(0);</span>
<span class="nc" id="L126">        LocalDateTime fimDia = LocalDateTime.now().withHour(23).withMinute(59).withSecond(59);</span>
        
<span class="nc" id="L128">        List&lt;Interacao&gt; atividadesHoje = interacaoRepository.findByDataProximaAcao(LocalDateTime.now())</span>
<span class="nc" id="L129">                .stream()</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">                .filter(i -&gt; !i.getConcluida())</span>
<span class="nc" id="L131">                .collect(Collectors.toList());</span>

<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (atividadesHoje.isEmpty()) {</span>
<span class="nc" id="L134">            return &quot;Voc√™ n√£o tem atividades agendadas para hoje. Aproveite para prospectar novos leads! üéØ&quot;;</span>
        }

<span class="nc" id="L137">        StringBuilder resposta = new StringBuilder(String.format(&quot;Voc√™ tem %d atividade(s) para hoje:\n\n&quot;, atividadesHoje.size()));</span>
        
<span class="nc" id="L139">        DateTimeFormatter formatter = DateTimeFormatter.ofPattern(&quot;HH:mm&quot;);</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">        for (Interacao atividade : atividadesHoje) {</span>
<span class="nc" id="L141">            resposta.append(String.format(&quot;‚Ä¢ %s - %s (%s)\n&quot;,</span>
<span class="nc" id="L142">                    atividade.getDataProximaAcao().format(formatter),</span>
<span class="nc" id="L143">                    atividade.getAssunto(),</span>
<span class="nc" id="L144">                    mapTipoInteracao(atividade.getTipo())));</span>
        }

<span class="nc" id="L147">        return resposta.toString();</span>
    }

    private String buscarValorPropostas() {
<span class="nc" id="L151">        Double valorAbertas = interacaoRepository.somarValorPropostasAbertas();</span>
<span class="nc" id="L152">        Double valorGanhas = interacaoRepository.somarValorPropostasGanhas();</span>
<span class="nc" id="L153">        Long qtdAbertas = interacaoRepository.contarPropostasAbertas();</span>
<span class="nc" id="L154">        Long qtdGanhas = interacaoRepository.contarPropostasGanhas();</span>
        
<span class="nc" id="L156">        return String.format(&quot;üí∞ Situa√ß√£o das propostas:\n\n&quot; +</span>
                           &quot;Propostas em aberto:\n&quot; +
                           &quot;‚Ä¢ %d proposta(s)\n&quot; +
                           &quot;‚Ä¢ Valor total: R$ %.2f\n\n&quot; +
                           &quot;Propostas fechadas:\n&quot; +
                           &quot;‚Ä¢ %d proposta(s)\n&quot; +
                           &quot;‚Ä¢ Valor total: R$ %.2f\n\n&quot; +
                           &quot;Continue trabalhando nas propostas abertas! üöÄ&quot;,
<span class="nc" id="L164">                           qtdAbertas, valorAbertas,</span>
<span class="nc" id="L165">                           qtdGanhas, valorGanhas);</span>
    }

    private String buscarUltimaAtividade() {
<span class="nc" id="L169">        List&lt;Interacao&gt; atividades = interacaoRepository.findAll();</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (atividades.isEmpty()) {</span>
<span class="nc" id="L171">            return &quot;Nenhuma atividade registrada ainda.&quot;;</span>
        }

<span class="nc" id="L174">        Interacao ultima = atividades.stream()</span>
<span class="nc" id="L175">                .max(Comparator.comparing(Interacao::getDataCriacao))</span>
<span class="nc" id="L176">                .orElse(null);</span>

<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (ultima == null) {</span>
<span class="nc" id="L179">            return &quot;Nenhuma atividade encontrada.&quot;;</span>
        }

<span class="nc" id="L182">        DateTimeFormatter formatter = DateTimeFormatter.ofPattern(&quot;dd/MM/yyyy '√†s' HH:mm&quot;);</span>
<span class="nc" id="L183">        return String.format(&quot;Sua √∫ltima atividade foi:\n\n&quot; +</span>
                           &quot;üìÖ %s\n&quot; +
                           &quot;üè¢ %s\n&quot; +
                           &quot;üìù %s\n&quot; +
                           &quot;Tipo: %s&quot;,
<span class="nc" id="L188">                           ultima.getDataCriacao().format(formatter),</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">                           ultima.getExpositor().getNomeFantasia() != null ? </span>
<span class="nc" id="L190">                               ultima.getExpositor().getNomeFantasia() : </span>
<span class="nc" id="L191">                               ultima.getExpositor().getRazaoSocial(),</span>
<span class="nc" id="L192">                           ultima.getAssunto(),</span>
<span class="nc" id="L193">                           mapTipoInteracao(ultima.getTipo()));</span>
    }

    private String buscarAtividadesPendentes() {
<span class="nc" id="L197">        LocalDateTime agora = LocalDateTime.now();</span>
<span class="nc" id="L198">        List&lt;Interacao&gt; pendentes = interacaoRepository.findProximasAcoes(agora.plusDays(7))</span>
<span class="nc" id="L199">                .stream()</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">                .filter(i -&gt; !i.getConcluida())</span>
<span class="nc" id="L201">                .sorted(Comparator.comparing(Interacao::getDataProximaAcao))</span>
<span class="nc" id="L202">                .limit(5)</span>
<span class="nc" id="L203">                .collect(Collectors.toList());</span>

<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (pendentes.isEmpty()) {</span>
<span class="nc" id="L206">            return &quot;Parab√©ns! Voc√™ n√£o tem atividades pendentes para os pr√≥ximos 7 dias. ‚úÖ&quot;;</span>
        }

<span class="nc" id="L209">        StringBuilder resposta = new StringBuilder(String.format(&quot;Voc√™ tem %d atividade(s) pendente(s):\n\n&quot;, pendentes.size()));</span>
        
<span class="nc" id="L211">        DateTimeFormatter formatter = DateTimeFormatter.ofPattern(&quot;dd/MM '√†s' HH:mm&quot;);</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">        for (Interacao atividade : pendentes) {</span>
<span class="nc" id="L213">            resposta.append(String.format(&quot;‚Ä¢ %s - %s\n&quot;,</span>
<span class="nc" id="L214">                    atividade.getDataProximaAcao().format(formatter),</span>
<span class="nc" id="L215">                    atividade.getAssunto()));</span>
        }

<span class="nc" id="L218">        return resposta.toString();</span>
    }

    private String buscarMetrosVendidos() {
<span class="nc" id="L222">        Double metrosVendidos = interacaoRepository.somarMetrosQuadradosVendidos();</span>
<span class="nc" id="L223">        return String.format(&quot;üìè Total de √°rea vendida: %.2f m¬≤\n\n&quot; +</span>
                           &quot;Excelente trabalho! Continue assim! üéâ&quot;,
<span class="nc bnc" id="L225" title="All 2 branches missed.">                           metrosVendidos != null ? metrosVendidos : 0.0);</span>
    }

    private String gerarResumo() {
<span class="nc" id="L229">        long totalLeads = expositorRepository.count();</span>
<span class="nc" id="L230">        long totalAtividades = interacaoRepository.count();</span>
<span class="nc" id="L231">        Double valorPropostas = interacaoRepository.somarValorPropostasAbertas();</span>
<span class="nc" id="L232">        Double metrosVendidos = interacaoRepository.somarMetrosQuadradosVendidos();</span>
<span class="nc" id="L233">        Long qtdGanhos = interacaoRepository.contarPropostasGanhas();</span>
        
<span class="nc" id="L235">        LocalDateTime agora = LocalDateTime.now();</span>
<span class="nc" id="L236">        long atividadesHoje = interacaoRepository.findByDataProximaAcao(agora)</span>
<span class="nc" id="L237">                .stream()</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">                .filter(i -&gt; !i.getConcluida())</span>
<span class="nc" id="L239">                .count();</span>

<span class="nc" id="L241">        return String.format(&quot;üìä Resumo do CRM:\n\n&quot; +</span>
                           &quot;üë• Total de leads: %d\n&quot; +
                           &quot;üìã Total de atividades: %d\n&quot; +
                           &quot;üìÖ Atividades hoje: %d\n\n&quot; +
                           &quot;üí∞ Propostas em aberto: R$ %.2f\n&quot; +
                           &quot;‚úÖ Neg√≥cios fechados: %d\n&quot; +
                           &quot;üìè √Årea vendida: %.2f m¬≤\n\n&quot; +
                           &quot;Continue o √≥timo trabalho! üöÄ&quot;,
<span class="nc" id="L249">                           totalLeads, totalAtividades, atividadesHoje,</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">                           valorPropostas != null ? valorPropostas : 0.0,</span>
<span class="nc" id="L251">                           qtdGanhos,</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">                           metrosVendidos != null ? metrosVendidos : 0.0);</span>
    }

    private String mapTipoInteracao(Interacao.TipoInteracao tipo) {
<span class="nc bnc" id="L256" title="All 7 branches missed.">        switch (tipo) {</span>
<span class="nc" id="L257">            case LIGACAO: return &quot;Liga√ß√£o&quot;;</span>
<span class="nc" id="L258">            case EMAIL: return &quot;Email&quot;;</span>
<span class="nc" id="L259">            case REUNIAO: return &quot;Reuni√£o&quot;;</span>
<span class="nc" id="L260">            case WHATSAPP: return &quot;WhatsApp&quot;;</span>
<span class="nc" id="L261">            case PROPOSTA: return &quot;Proposta&quot;;</span>
<span class="nc" id="L262">            case FECHADO: return &quot;Fechado&quot;;</span>
<span class="nc" id="L263">            default: return &quot;Outros&quot;;</span>
        }
    }
}


</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>