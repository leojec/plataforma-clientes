<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RelatoriosController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">crmshot-backend</a> &gt; <a href="index.source.html" class="el_package">com.crmshot.controller</a> &gt; <span class="el_source">RelatoriosController.java</span></div><h1>RelatoriosController.java</h1><pre class="source lang-java linenums">package com.crmshot.controller;

import com.crmshot.repository.ExpositorRepository;
import com.crmshot.repository.InteracaoRepository;
import com.crmshot.repository.OportunidadeRepository;
import com.crmshot.repository.UsuarioRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;
import java.util.stream.Collectors;

@RestController
@RequestMapping(&quot;/api/relatorios&quot;)
@CrossOrigin(origins = &quot;*&quot;)
<span class="nc" id="L19">public class RelatoriosController {</span>

    @Autowired
    private ExpositorRepository expositorRepository;

    @Autowired
    private InteracaoRepository interacaoRepository;

    @Autowired
    private OportunidadeRepository oportunidadeRepository;

    @Autowired
    private UsuarioRepository usuarioRepository;

    @GetMapping(&quot;/oportunidades-por-status&quot;)
    public Map&lt;String, Object&gt; getOportunidadesPorStatus() {
<span class="nc" id="L35">        Map&lt;String, Object&gt; resultado = new HashMap&lt;&gt;();</span>
        
        // Buscar todas as oportunidades e agrupar por status
<span class="nc" id="L38">        List&lt;com.crmshot.entity.Oportunidade&gt; oportunidades = oportunidadeRepository.findAll();</span>
        
<span class="nc" id="L40">        Map&lt;com.crmshot.entity.Oportunidade.StatusOportunidade, Long&gt; contagemPorStatus = oportunidades.stream()</span>
<span class="nc" id="L41">            .collect(Collectors.groupingBy(</span>
<span class="nc" id="L42">                com.crmshot.entity.Oportunidade::getStatus,</span>
<span class="nc" id="L43">                Collectors.counting()</span>
            ));
        
<span class="nc" id="L46">        List&lt;Map&lt;String, Object&gt;&gt; dados = new ArrayList&lt;&gt;();</span>
        
        // Mapear os status para cores e nomes em português
<span class="nc" id="L49">        Map&lt;com.crmshot.entity.Oportunidade.StatusOportunidade, Map&lt;String, Object&gt;&gt; statusInfo = new HashMap&lt;&gt;();</span>
<span class="nc" id="L50">        statusInfo.put(com.crmshot.entity.Oportunidade.StatusOportunidade.PROSPECCAO, </span>
<span class="nc" id="L51">            Map.of(&quot;nome&quot;, &quot;Lead&quot;, &quot;cor&quot;, &quot;#3B82F6&quot;));</span>
<span class="nc" id="L52">        statusInfo.put(com.crmshot.entity.Oportunidade.StatusOportunidade.QUALIFICACAO, </span>
<span class="nc" id="L53">            Map.of(&quot;nome&quot;, &quot;Em Andamento&quot;, &quot;cor&quot;, &quot;#F59E0B&quot;));</span>
<span class="nc" id="L54">        statusInfo.put(com.crmshot.entity.Oportunidade.StatusOportunidade.PROPOSTA, </span>
<span class="nc" id="L55">            Map.of(&quot;nome&quot;, &quot;Em Negociação&quot;, &quot;cor&quot;, &quot;#8B5CF6&quot;));</span>
<span class="nc" id="L56">        statusInfo.put(com.crmshot.entity.Oportunidade.StatusOportunidade.NEGOCIACAO, </span>
<span class="nc" id="L57">            Map.of(&quot;nome&quot;, &quot;Em Negociação&quot;, &quot;cor&quot;, &quot;#8B5CF6&quot;));</span>
<span class="nc" id="L58">        statusInfo.put(com.crmshot.entity.Oportunidade.StatusOportunidade.FECHADA_GANHA, </span>
<span class="nc" id="L59">            Map.of(&quot;nome&quot;, &quot;Stand Fechado&quot;, &quot;cor&quot;, &quot;#10B981&quot;));</span>
<span class="nc" id="L60">        statusInfo.put(com.crmshot.entity.Oportunidade.StatusOportunidade.FECHADA_PERDIDA, </span>
<span class="nc" id="L61">            Map.of(&quot;nome&quot;, &quot;Perdida&quot;, &quot;cor&quot;, &quot;#EF4444&quot;));</span>
        
<span class="nc bnc" id="L63" title="All 2 branches missed.">        for (Map.Entry&lt;com.crmshot.entity.Oportunidade.StatusOportunidade, Long&gt; entry : contagemPorStatus.entrySet()) {</span>
<span class="nc" id="L64">            Map&lt;String, Object&gt; statusData = statusInfo.get(entry.getKey());</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">            if (statusData != null) {</span>
<span class="nc" id="L66">                Map&lt;String, Object&gt; item = new HashMap&lt;&gt;();</span>
<span class="nc" id="L67">                item.put(&quot;name&quot;, statusData.get(&quot;nome&quot;));</span>
<span class="nc" id="L68">                item.put(&quot;value&quot;, entry.getValue());</span>
<span class="nc" id="L69">                item.put(&quot;color&quot;, statusData.get(&quot;cor&quot;));</span>
<span class="nc" id="L70">                dados.add(item);</span>
            }
        }
        
<span class="nc" id="L74">        resultado.put(&quot;dados&quot;, dados);</span>
<span class="nc" id="L75">        return resultado;</span>
    }

    @GetMapping(&quot;/vendas-por-mes&quot;)
    public Map&lt;String, Object&gt; getVendasPorMes() {
<span class="nc" id="L80">        Map&lt;String, Object&gt; resultado = new HashMap&lt;&gt;();</span>
        
        // Buscar oportunidades fechadas e ganhas dos últimos 6 meses
<span class="nc" id="L83">        LocalDateTime dataLimite = LocalDateTime.now().minusMonths(6);</span>
<span class="nc" id="L84">        List&lt;com.crmshot.entity.Oportunidade&gt; oportunidades = oportunidadeRepository.findAll();</span>
        
        // Filtrar apenas oportunidades fechadas e ganhas dos últimos 6 meses
<span class="nc" id="L87">        List&lt;com.crmshot.entity.Oportunidade&gt; oportunidadesFechadas = oportunidades.stream()</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">            .filter(op -&gt; op.getStatus() == com.crmshot.entity.Oportunidade.StatusOportunidade.FECHADA_GANHA)</span>
<span class="nc" id="L89">            .filter(op -&gt; op.getDataCriacao().isAfter(dataLimite))</span>
<span class="nc" id="L90">            .collect(Collectors.toList());</span>
        
        // Agrupar por mês
<span class="nc" id="L93">        Map&lt;String, BigDecimal&gt; vendasPorMes = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L94">        String[] meses = {&quot;Jan&quot;, &quot;Fev&quot;, &quot;Mar&quot;, &quot;Abr&quot;, &quot;Mai&quot;, &quot;Jun&quot;, &quot;Jul&quot;, &quot;Ago&quot;, &quot;Set&quot;, &quot;Out&quot;, &quot;Nov&quot;, &quot;Dez&quot;};</span>
        
        // Inicializar todos os meses com zero
<span class="nc bnc" id="L97" title="All 2 branches missed.">        for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc" id="L98">            LocalDateTime mesAtual = LocalDateTime.now().minusMonths(i);</span>
<span class="nc" id="L99">            String mesNome = meses[mesAtual.getMonthValue() - 1];</span>
<span class="nc" id="L100">            vendasPorMes.put(mesNome, BigDecimal.ZERO);</span>
        }
        
        // Somar valores por mês
<span class="nc bnc" id="L104" title="All 2 branches missed.">        for (com.crmshot.entity.Oportunidade oportunidade : oportunidadesFechadas) {</span>
<span class="nc" id="L105">            String mesNome = meses[oportunidade.getDataCriacao().getMonthValue() - 1];</span>
<span class="nc" id="L106">            BigDecimal valorAtual = vendasPorMes.get(mesNome);</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">            BigDecimal valorOportunidade = oportunidade.getValorEstimado() != null ? </span>
<span class="nc" id="L108">                oportunidade.getValorEstimado() : BigDecimal.ZERO;</span>
<span class="nc" id="L109">            vendasPorMes.put(mesNome, valorAtual.add(valorOportunidade));</span>
        }
        
<span class="nc" id="L112">        List&lt;Map&lt;String, Object&gt;&gt; dados = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">        for (Map.Entry&lt;String, BigDecimal&gt; entry : vendasPorMes.entrySet()) {</span>
<span class="nc" id="L114">            Map&lt;String, Object&gt; item = new HashMap&lt;&gt;();</span>
<span class="nc" id="L115">            item.put(&quot;mes&quot;, entry.getKey());</span>
<span class="nc" id="L116">            item.put(&quot;vendas&quot;, entry.getValue().doubleValue());</span>
<span class="nc" id="L117">            dados.add(item);</span>
        }
        
<span class="nc" id="L120">        resultado.put(&quot;dados&quot;, dados);</span>
<span class="nc" id="L121">        return resultado;</span>
    }

    @GetMapping(&quot;/performance-vendedores&quot;)
    public Map&lt;String, Object&gt; getPerformanceVendedores() {
<span class="nc" id="L126">        Map&lt;String, Object&gt; resultado = new HashMap&lt;&gt;();</span>
        
        // Buscar todos os vendedores
<span class="nc" id="L129">        List&lt;com.crmshot.entity.Usuario&gt; vendedores = usuarioRepository.findByAtivoTrue();</span>
        
<span class="nc" id="L131">        List&lt;Map&lt;String, Object&gt;&gt; dados = new ArrayList&lt;&gt;();</span>
        
<span class="nc bnc" id="L133" title="All 2 branches missed.">        for (com.crmshot.entity.Usuario vendedor : vendedores) {</span>
            // Buscar oportunidades do vendedor
<span class="nc" id="L135">            List&lt;com.crmshot.entity.Oportunidade&gt; oportunidades = oportunidadeRepository.findByVendedorId(vendedor.getId());</span>
            
            // Calcular métricas
<span class="nc" id="L138">            long totalOportunidades = oportunidades.size();</span>
<span class="nc" id="L139">            long oportunidadesGanhas = oportunidades.stream()</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">                .filter(op -&gt; op.getStatus() == com.crmshot.entity.Oportunidade.StatusOportunidade.FECHADA_GANHA)</span>
<span class="nc" id="L141">                .count();</span>
            
<span class="nc" id="L143">            BigDecimal totalVendas = oportunidades.stream()</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">                .filter(op -&gt; op.getStatus() == com.crmshot.entity.Oportunidade.StatusOportunidade.FECHADA_GANHA)</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">                .map(op -&gt; op.getValorEstimado() != null ? op.getValorEstimado() : BigDecimal.ZERO)</span>
<span class="nc" id="L146">                .reduce(BigDecimal.ZERO, BigDecimal::add);</span>
            
<span class="nc bnc" id="L148" title="All 2 branches missed.">            BigDecimal ticketMedio = totalOportunidades &gt; 0 ? </span>
<span class="nc" id="L149">                totalVendas.divide(BigDecimal.valueOf(totalOportunidades), 2, java.math.RoundingMode.HALF_UP) : </span>
<span class="nc" id="L150">                BigDecimal.ZERO;</span>
            
<span class="nc bnc" id="L152" title="All 2 branches missed.">            double taxaConversao = totalOportunidades &gt; 0 ? </span>
<span class="nc" id="L153">                (double) oportunidadesGanhas / totalOportunidades * 100 : 0;</span>
            
<span class="nc" id="L155">            Map&lt;String, Object&gt; vendedorData = new HashMap&lt;&gt;();</span>
<span class="nc" id="L156">            vendedorData.put(&quot;vendedor&quot;, vendedor.getNome());</span>
<span class="nc" id="L157">            vendedorData.put(&quot;vendas&quot;, totalVendas.doubleValue());</span>
<span class="nc" id="L158">            vendedorData.put(&quot;oportunidades&quot;, totalOportunidades);</span>
<span class="nc" id="L159">            vendedorData.put(&quot;ticketMedio&quot;, ticketMedio.doubleValue());</span>
<span class="nc" id="L160">            vendedorData.put(&quot;conversao&quot;, Math.round(taxaConversao));</span>
            
<span class="nc" id="L162">            dados.add(vendedorData);</span>
        }
        
<span class="nc" id="L165">        resultado.put(&quot;dados&quot;, dados);</span>
<span class="nc" id="L166">        return resultado;</span>
    }

    @GetMapping(&quot;/debug-oportunidades&quot;)
    public Map&lt;String, Object&gt; getDebugOportunidades() {
<span class="nc" id="L171">        Map&lt;String, Object&gt; resultado = new HashMap&lt;&gt;();</span>
        
        // Buscar todas as oportunidades
<span class="nc" id="L174">        List&lt;com.crmshot.entity.Oportunidade&gt; todasOportunidades = oportunidadeRepository.findAll();</span>
        
<span class="nc" id="L176">        resultado.put(&quot;totalOportunidades&quot;, todasOportunidades.size());</span>
<span class="nc" id="L177">        resultado.put(&quot;oportunidades&quot;, todasOportunidades.stream().map(op -&gt; {</span>
<span class="nc" id="L178">            Map&lt;String, Object&gt; opData = new HashMap&lt;&gt;();</span>
<span class="nc" id="L179">            opData.put(&quot;id&quot;, op.getId());</span>
<span class="nc" id="L180">            opData.put(&quot;titulo&quot;, op.getTitulo());</span>
<span class="nc" id="L181">            opData.put(&quot;status&quot;, op.getStatus());</span>
<span class="nc" id="L182">            opData.put(&quot;valorEstimado&quot;, op.getValorEstimado());</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">            opData.put(&quot;vendedor&quot;, op.getVendedor() != null ? op.getVendedor().getNome() : &quot;N/A&quot;);</span>
<span class="nc" id="L184">            return opData;</span>
<span class="nc" id="L185">        }).collect(Collectors.toList()));</span>
        
<span class="nc" id="L187">        return resultado;</span>
    }

    @GetMapping(&quot;/atividades-por-periodo&quot;)
    public Map&lt;String, Object&gt; getAtividadesPorPeriodo(@RequestParam(defaultValue = &quot;6&quot;) int meses) {
<span class="nc" id="L192">        Map&lt;String, Object&gt; resultado = new HashMap&lt;&gt;();</span>
        
        // Calcular período
<span class="nc" id="L195">        LocalDateTime dataInicio = LocalDateTime.now().minusMonths(meses);</span>
<span class="nc" id="L196">        LocalDateTime dataFim = LocalDateTime.now();</span>
        
        // Buscar atividades por período
<span class="nc" id="L199">        List&lt;com.crmshot.entity.Interacao&gt; atividades = interacaoRepository.findAll().stream()</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">            .filter(interacao -&gt; interacao.getDataCriacao().isAfter(dataInicio) &amp;&amp; </span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">                               interacao.getDataCriacao().isBefore(dataFim))</span>
<span class="nc" id="L202">            .collect(java.util.stream.Collectors.toList());</span>
        
        // Agrupar por mês
<span class="nc" id="L205">        Map&lt;String, Long&gt; atividadesPorMes = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L206">        String[] mesesNomes = {&quot;Jan&quot;, &quot;Fev&quot;, &quot;Mar&quot;, &quot;Abr&quot;, &quot;Mai&quot;, &quot;Jun&quot;, &quot;Jul&quot;, &quot;Ago&quot;, &quot;Set&quot;, &quot;Out&quot;, &quot;Nov&quot;, &quot;Dez&quot;};</span>
        
<span class="nc bnc" id="L208" title="All 2 branches missed.">        for (int i = 0; i &lt; meses; i++) {</span>
<span class="nc" id="L209">            LocalDateTime mesAtual = LocalDateTime.now().minusMonths(i);</span>
<span class="nc" id="L210">            String mesNome = mesesNomes[mesAtual.getMonthValue() - 1];</span>
<span class="nc" id="L211">            atividadesPorMes.put(mesNome, 0L);</span>
        }
        
        // Contar atividades por mês
<span class="nc bnc" id="L215" title="All 2 branches missed.">        for (com.crmshot.entity.Interacao atividade : atividades) {</span>
<span class="nc" id="L216">            String mesNome = mesesNomes[atividade.getDataCriacao().getMonthValue() - 1];</span>
<span class="nc" id="L217">            atividadesPorMes.put(mesNome, atividadesPorMes.get(mesNome) + 1);</span>
        }
        
<span class="nc" id="L220">        List&lt;Map&lt;String, Object&gt;&gt; dados = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">        for (Map.Entry&lt;String, Long&gt; entry : atividadesPorMes.entrySet()) {</span>
<span class="nc" id="L222">            Map&lt;String, Object&gt; item = new HashMap&lt;&gt;();</span>
<span class="nc" id="L223">            item.put(&quot;mes&quot;, entry.getKey());</span>
<span class="nc" id="L224">            item.put(&quot;atividades&quot;, entry.getValue());</span>
<span class="nc" id="L225">            dados.add(item);</span>
        }
        
<span class="nc" id="L228">        resultado.put(&quot;dados&quot;, dados);</span>
<span class="nc" id="L229">        resultado.put(&quot;totalAtividades&quot;, atividades.size());</span>
<span class="nc" id="L230">        resultado.put(&quot;periodo&quot;, meses + &quot; meses&quot;);</span>
        
<span class="nc" id="L232">        return resultado;</span>
    }

    @GetMapping(&quot;/resumo-executivo&quot;)
    public Map&lt;String, Object&gt; getResumoExecutivo() {
<span class="nc" id="L237">        Map&lt;String, Object&gt; resultado = new HashMap&lt;&gt;();</span>
        
        // Buscar dados gerais
<span class="nc" id="L240">        long totalExpositores = expositorRepository.count();</span>
<span class="nc" id="L241">        long totalOportunidades = oportunidadeRepository.count();</span>
<span class="nc" id="L242">        long totalInteracoes = interacaoRepository.count();</span>
        
        // Calcular valores
<span class="nc" id="L245">        List&lt;com.crmshot.entity.Oportunidade&gt; oportunidades = oportunidadeRepository.findAll();</span>
<span class="nc" id="L246">        BigDecimal valorTotalEstimado = oportunidades.stream()</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">            .map(op -&gt; op.getValorEstimado() != null ? op.getValorEstimado() : BigDecimal.ZERO)</span>
<span class="nc" id="L248">            .reduce(BigDecimal.ZERO, BigDecimal::add);</span>
        
<span class="nc" id="L250">        BigDecimal valorGanho = oportunidades.stream()</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">            .filter(op -&gt; op.getStatus() == com.crmshot.entity.Oportunidade.StatusOportunidade.FECHADA_GANHA)</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">            .map(op -&gt; op.getValorEstimado() != null ? op.getValorEstimado() : BigDecimal.ZERO)</span>
<span class="nc" id="L253">            .reduce(BigDecimal.ZERO, BigDecimal::add);</span>
        
<span class="nc" id="L255">        BigDecimal valorEmAberto = oportunidades.stream()</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">            .filter(op -&gt; op.getStatus() != com.crmshot.entity.Oportunidade.StatusOportunidade.FECHADA_GANHA &amp;&amp;</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">                         op.getStatus() != com.crmshot.entity.Oportunidade.StatusOportunidade.FECHADA_PERDIDA)</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">            .map(op -&gt; op.getValorEstimado() != null ? op.getValorEstimado() : BigDecimal.ZERO)</span>
<span class="nc" id="L259">            .reduce(BigDecimal.ZERO, BigDecimal::add);</span>
        
<span class="nc" id="L261">        resultado.put(&quot;totalExpositores&quot;, totalExpositores);</span>
<span class="nc" id="L262">        resultado.put(&quot;totalOportunidades&quot;, totalOportunidades);</span>
<span class="nc" id="L263">        resultado.put(&quot;totalInteracoes&quot;, totalInteracoes);</span>
<span class="nc" id="L264">        resultado.put(&quot;valorTotalEstimado&quot;, valorTotalEstimado.doubleValue());</span>
<span class="nc" id="L265">        resultado.put(&quot;valorGanho&quot;, valorGanho.doubleValue());</span>
<span class="nc" id="L266">        resultado.put(&quot;valorEmAberto&quot;, valorEmAberto.doubleValue());</span>
        
<span class="nc" id="L268">        return resultado;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>