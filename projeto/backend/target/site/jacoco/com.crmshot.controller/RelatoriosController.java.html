<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RelatoriosController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">crmshot-backend</a> &gt; <a href="index.source.html" class="el_package">com.crmshot.controller</a> &gt; <span class="el_source">RelatoriosController.java</span></div><h1>RelatoriosController.java</h1><pre class="source lang-java linenums">package com.crmshot.controller;

import com.crmshot.repository.ExpositorRepository;
import com.crmshot.repository.InteracaoRepository;
import com.crmshot.repository.OportunidadeRepository;
import com.crmshot.repository.UsuarioRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

@RestController
@RequestMapping(&quot;/api/relatorios&quot;)
@CrossOrigin(origins = &quot;*&quot;)
<span class="fc" id="L18">public class RelatoriosController {</span>

    private static final String KEY_DADOS = &quot;dados&quot;;

    @Autowired
    private ExpositorRepository expositorRepository;

    @Autowired
    private InteracaoRepository interacaoRepository;

    @Autowired
    private OportunidadeRepository oportunidadeRepository;

    @Autowired
    private UsuarioRepository usuarioRepository;

    @GetMapping(&quot;/oportunidades-por-status&quot;)
    public Map&lt;String, Object&gt; getOportunidadesPorStatus() {
<span class="fc" id="L36">        Map&lt;String, Object&gt; resultado = new HashMap&lt;&gt;();</span>
        
        // Buscar todas as oportunidades e agrupar por status
<span class="fc" id="L39">        List&lt;com.crmshot.entity.Oportunidade&gt; oportunidades = oportunidadeRepository.findAll();</span>
        
<span class="fc" id="L41">        Map&lt;com.crmshot.entity.Oportunidade.StatusOportunidade, Long&gt; contagemPorStatus = oportunidades.stream()</span>
<span class="fc" id="L42">            .collect(Collectors.groupingBy(</span>
                com.crmshot.entity.Oportunidade::getStatus,
<span class="fc" id="L44">                Collectors.counting()</span>
            ));
        
<span class="fc" id="L47">        List&lt;Map&lt;String, Object&gt;&gt; dados = new ArrayList&lt;&gt;();</span>
        
        // Mapear os status para cores e nomes em português
<span class="fc" id="L50">        Map&lt;com.crmshot.entity.Oportunidade.StatusOportunidade, Map&lt;String, Object&gt;&gt; statusInfo = new HashMap&lt;&gt;();</span>
<span class="fc" id="L51">        statusInfo.put(com.crmshot.entity.Oportunidade.StatusOportunidade.PROSPECCAO, </span>
<span class="fc" id="L52">            Map.of(&quot;nome&quot;, &quot;Lead&quot;, &quot;cor&quot;, &quot;#3B82F6&quot;));</span>
<span class="fc" id="L53">        statusInfo.put(com.crmshot.entity.Oportunidade.StatusOportunidade.QUALIFICACAO, </span>
<span class="fc" id="L54">            Map.of(&quot;nome&quot;, &quot;Em Andamento&quot;, &quot;cor&quot;, &quot;#F59E0B&quot;));</span>
<span class="fc" id="L55">        statusInfo.put(com.crmshot.entity.Oportunidade.StatusOportunidade.PROPOSTA, </span>
<span class="fc" id="L56">            Map.of(&quot;nome&quot;, &quot;Em Negociação&quot;, &quot;cor&quot;, &quot;#8B5CF6&quot;));</span>
<span class="fc" id="L57">        statusInfo.put(com.crmshot.entity.Oportunidade.StatusOportunidade.NEGOCIACAO, </span>
<span class="fc" id="L58">            Map.of(&quot;nome&quot;, &quot;Em Negociação&quot;, &quot;cor&quot;, &quot;#8B5CF6&quot;));</span>
<span class="fc" id="L59">        statusInfo.put(com.crmshot.entity.Oportunidade.StatusOportunidade.FECHADA_GANHA, </span>
<span class="fc" id="L60">            Map.of(&quot;nome&quot;, &quot;Stand Fechado&quot;, &quot;cor&quot;, &quot;#10B981&quot;));</span>
<span class="fc" id="L61">        statusInfo.put(com.crmshot.entity.Oportunidade.StatusOportunidade.FECHADA_PERDIDA, </span>
<span class="fc" id="L62">            Map.of(&quot;nome&quot;, &quot;Perdida&quot;, &quot;cor&quot;, &quot;#EF4444&quot;));</span>
        
<span class="fc bfc" id="L64" title="All 2 branches covered.">        for (Map.Entry&lt;com.crmshot.entity.Oportunidade.StatusOportunidade, Long&gt; entry : contagemPorStatus.entrySet()) {</span>
<span class="fc" id="L65">            Map&lt;String, Object&gt; statusData = statusInfo.get(entry.getKey());</span>
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">            if (statusData != null) {</span>
<span class="fc" id="L67">                Map&lt;String, Object&gt; item = new HashMap&lt;&gt;();</span>
<span class="fc" id="L68">                item.put(&quot;name&quot;, statusData.get(&quot;nome&quot;));</span>
<span class="fc" id="L69">                item.put(&quot;value&quot;, entry.getValue());</span>
<span class="fc" id="L70">                item.put(&quot;color&quot;, statusData.get(&quot;cor&quot;));</span>
<span class="fc" id="L71">                dados.add(item);</span>
            }
<span class="fc" id="L73">        }</span>
        
<span class="fc" id="L75">        resultado.put(KEY_DADOS, dados);</span>
<span class="fc" id="L76">        return resultado;</span>
    }

    @GetMapping(&quot;/vendas-por-mes&quot;)
    public Map&lt;String, Object&gt; getVendasPorMes() {
<span class="fc" id="L81">        Map&lt;String, Object&gt; resultado = new HashMap&lt;&gt;();</span>
        
        // Buscar oportunidades fechadas e ganhas dos últimos 6 meses
<span class="fc" id="L84">        LocalDateTime dataLimite = LocalDateTime.now().minusMonths(6);</span>
<span class="fc" id="L85">        List&lt;com.crmshot.entity.Oportunidade&gt; oportunidades = oportunidadeRepository.findAll();</span>
        
        // Filtrar apenas oportunidades fechadas e ganhas dos últimos 6 meses
<span class="fc" id="L88">        List&lt;com.crmshot.entity.Oportunidade&gt; oportunidadesFechadas = oportunidades.stream()</span>
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">            .filter(op -&gt; op.getStatus() == com.crmshot.entity.Oportunidade.StatusOportunidade.FECHADA_GANHA)</span>
<span class="fc" id="L90">            .filter(op -&gt; op.getDataCriacao().isAfter(dataLimite))</span>
<span class="fc" id="L91">            .collect(Collectors.toList());</span>
        
        // Agrupar por mês
<span class="fc" id="L94">        Map&lt;String, BigDecimal&gt; vendasPorMes = new LinkedHashMap&lt;&gt;();</span>
<span class="fc" id="L95">        String[] meses = {&quot;Jan&quot;, &quot;Fev&quot;, &quot;Mar&quot;, &quot;Abr&quot;, &quot;Mai&quot;, &quot;Jun&quot;, &quot;Jul&quot;, &quot;Ago&quot;, &quot;Set&quot;, &quot;Out&quot;, &quot;Nov&quot;, &quot;Dez&quot;};</span>
        
        // Inicializar todos os meses com zero
<span class="fc bfc" id="L98" title="All 2 branches covered.">        for (int i = 0; i &lt; 6; i++) {</span>
<span class="fc" id="L99">            LocalDateTime mesAtual = LocalDateTime.now().minusMonths(i);</span>
<span class="fc" id="L100">            String mesNome = meses[mesAtual.getMonthValue() - 1];</span>
<span class="fc" id="L101">            vendasPorMes.put(mesNome, BigDecimal.ZERO);</span>
        }
        
        // Somar valores por mês
<span class="fc bfc" id="L105" title="All 2 branches covered.">        for (com.crmshot.entity.Oportunidade oportunidade : oportunidadesFechadas) {</span>
<span class="fc" id="L106">            String mesNome = meses[oportunidade.getDataCriacao().getMonthValue() - 1];</span>
<span class="fc" id="L107">            BigDecimal valorAtual = vendasPorMes.get(mesNome);</span>
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">            BigDecimal valorOportunidade = oportunidade.getValorEstimado() != null ? </span>
<span class="pc" id="L109">                oportunidade.getValorEstimado() : BigDecimal.ZERO;</span>
<span class="fc" id="L110">            vendasPorMes.put(mesNome, valorAtual.add(valorOportunidade));</span>
<span class="fc" id="L111">        }</span>
        
<span class="fc" id="L113">        List&lt;Map&lt;String, Object&gt;&gt; dados = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">        for (Map.Entry&lt;String, BigDecimal&gt; entry : vendasPorMes.entrySet()) {</span>
<span class="fc" id="L115">            Map&lt;String, Object&gt; item = new HashMap&lt;&gt;();</span>
<span class="fc" id="L116">            item.put(&quot;mes&quot;, entry.getKey());</span>
<span class="fc" id="L117">            item.put(&quot;vendas&quot;, entry.getValue().doubleValue());</span>
<span class="fc" id="L118">            dados.add(item);</span>
<span class="fc" id="L119">        }</span>
        
<span class="fc" id="L121">        resultado.put(KEY_DADOS, dados);</span>
<span class="fc" id="L122">        return resultado;</span>
    }

    @GetMapping(&quot;/performance-vendedores&quot;)
    public Map&lt;String, Object&gt; getPerformanceVendedores() {
<span class="fc" id="L127">        Map&lt;String, Object&gt; resultado = new HashMap&lt;&gt;();</span>
        
        // Buscar todos os vendedores
<span class="fc" id="L130">        List&lt;com.crmshot.entity.Usuario&gt; vendedores = usuarioRepository.findByAtivoTrue();</span>
        
<span class="fc" id="L132">        List&lt;Map&lt;String, Object&gt;&gt; dados = new ArrayList&lt;&gt;();</span>
        
<span class="fc bfc" id="L134" title="All 2 branches covered.">        for (com.crmshot.entity.Usuario vendedor : vendedores) {</span>
            // Buscar oportunidades do vendedor
<span class="fc" id="L136">            List&lt;com.crmshot.entity.Oportunidade&gt; oportunidades = oportunidadeRepository.findByVendedorId(vendedor.getId());</span>
            
            // Calcular métricas
<span class="fc" id="L139">            long totalOportunidades = oportunidades.size();</span>
<span class="fc" id="L140">            long oportunidadesGanhas = oportunidades.stream()</span>
<span class="pc bnc" id="L141" title="All 2 branches missed.">                .filter(op -&gt; op.getStatus() == com.crmshot.entity.Oportunidade.StatusOportunidade.FECHADA_GANHA)</span>
<span class="fc" id="L142">                .count();</span>
            
<span class="fc" id="L144">            BigDecimal totalVendas = oportunidades.stream()</span>
<span class="pc bnc" id="L145" title="All 2 branches missed.">                .filter(op -&gt; op.getStatus() == com.crmshot.entity.Oportunidade.StatusOportunidade.FECHADA_GANHA)</span>
<span class="pc bnc" id="L146" title="All 2 branches missed.">                .map(op -&gt; op.getValorEstimado() != null ? op.getValorEstimado() : BigDecimal.ZERO)</span>
<span class="fc" id="L147">                .reduce(BigDecimal.ZERO, BigDecimal::add);</span>
            
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">            BigDecimal ticketMedio = totalOportunidades &gt; 0 ? </span>
<span class="nc" id="L150">                totalVendas.divide(BigDecimal.valueOf(totalOportunidades), 2, java.math.RoundingMode.HALF_UP) : </span>
<span class="fc" id="L151">                BigDecimal.ZERO;</span>
            
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">            double taxaConversao = totalOportunidades &gt; 0 ? </span>
<span class="pc" id="L154">                (double) oportunidadesGanhas / totalOportunidades * 100 : 0;</span>
            
<span class="fc" id="L156">            Map&lt;String, Object&gt; vendedorData = new HashMap&lt;&gt;();</span>
<span class="fc" id="L157">            vendedorData.put(&quot;vendedor&quot;, vendedor.getNome());</span>
<span class="fc" id="L158">            vendedorData.put(&quot;vendas&quot;, totalVendas.doubleValue());</span>
<span class="fc" id="L159">            vendedorData.put(&quot;oportunidades&quot;, totalOportunidades);</span>
<span class="fc" id="L160">            vendedorData.put(&quot;ticketMedio&quot;, ticketMedio.doubleValue());</span>
<span class="fc" id="L161">            vendedorData.put(&quot;conversao&quot;, Math.round(taxaConversao));</span>
            
<span class="fc" id="L163">            dados.add(vendedorData);</span>
<span class="fc" id="L164">        }</span>
        
<span class="fc" id="L166">        resultado.put(KEY_DADOS, dados);</span>
<span class="fc" id="L167">        return resultado;</span>
    }

    @GetMapping(&quot;/debug-oportunidades&quot;)
    public Map&lt;String, Object&gt; getDebugOportunidades() {
<span class="nc" id="L172">        Map&lt;String, Object&gt; resultado = new HashMap&lt;&gt;();</span>
        
        // Buscar todas as oportunidades
<span class="nc" id="L175">        List&lt;com.crmshot.entity.Oportunidade&gt; todasOportunidades = oportunidadeRepository.findAll();</span>
        
<span class="nc" id="L177">        resultado.put(&quot;totalOportunidades&quot;, todasOportunidades.size());</span>
<span class="nc" id="L178">        resultado.put(&quot;oportunidades&quot;, todasOportunidades.stream().map(op -&gt; {</span>
<span class="nc" id="L179">            Map&lt;String, Object&gt; opData = new HashMap&lt;&gt;();</span>
<span class="nc" id="L180">            opData.put(&quot;id&quot;, op.getId());</span>
<span class="nc" id="L181">            opData.put(&quot;titulo&quot;, op.getTitulo());</span>
<span class="nc" id="L182">            opData.put(&quot;status&quot;, op.getStatus());</span>
<span class="nc" id="L183">            opData.put(&quot;valorEstimado&quot;, op.getValorEstimado());</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">            opData.put(&quot;vendedor&quot;, op.getVendedor() != null ? op.getVendedor().getNome() : &quot;N/A&quot;);</span>
<span class="nc" id="L185">            return opData;</span>
<span class="nc" id="L186">        }).collect(Collectors.toList()));</span>
        
<span class="nc" id="L188">        return resultado;</span>
    }

    @GetMapping(&quot;/atividades-por-periodo&quot;)
    public Map&lt;String, Object&gt; getAtividadesPorPeriodo(@RequestParam(defaultValue = &quot;6&quot;) int meses) {
<span class="fc" id="L193">        Map&lt;String, Object&gt; resultado = new HashMap&lt;&gt;();</span>
        
        // Calcular período
<span class="fc" id="L196">        LocalDateTime dataInicio = LocalDateTime.now().minusMonths(meses);</span>
<span class="fc" id="L197">        LocalDateTime dataFim = LocalDateTime.now();</span>
        
        // Buscar atividades por período
<span class="fc" id="L200">        List&lt;com.crmshot.entity.Interacao&gt; atividades = interacaoRepository.findAll().stream()</span>
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">            .filter(interacao -&gt; interacao.getDataCriacao().isAfter(dataInicio) &amp;&amp; </span>
<span class="pc bpc" id="L202" title="1 of 2 branches missed.">                               interacao.getDataCriacao().isBefore(dataFim))</span>
<span class="fc" id="L203">            .collect(java.util.stream.Collectors.toList());</span>
        
        // Agrupar por mês
<span class="fc" id="L206">        Map&lt;String, Long&gt; atividadesPorMes = new LinkedHashMap&lt;&gt;();</span>
<span class="fc" id="L207">        String[] mesesNomes = {&quot;Jan&quot;, &quot;Fev&quot;, &quot;Mar&quot;, &quot;Abr&quot;, &quot;Mai&quot;, &quot;Jun&quot;, &quot;Jul&quot;, &quot;Ago&quot;, &quot;Set&quot;, &quot;Out&quot;, &quot;Nov&quot;, &quot;Dez&quot;};</span>
        
<span class="fc bfc" id="L209" title="All 2 branches covered.">        for (int i = 0; i &lt; meses; i++) {</span>
<span class="fc" id="L210">            LocalDateTime mesAtual = LocalDateTime.now().minusMonths(i);</span>
<span class="fc" id="L211">            String mesNome = mesesNomes[mesAtual.getMonthValue() - 1];</span>
<span class="fc" id="L212">            atividadesPorMes.put(mesNome, 0L);</span>
        }
        
        // Contar atividades por mês
<span class="fc bfc" id="L216" title="All 2 branches covered.">        for (com.crmshot.entity.Interacao atividade : atividades) {</span>
<span class="fc" id="L217">            String mesNome = mesesNomes[atividade.getDataCriacao().getMonthValue() - 1];</span>
<span class="fc" id="L218">            atividadesPorMes.put(mesNome, atividadesPorMes.get(mesNome) + 1);</span>
<span class="fc" id="L219">        }</span>
        
<span class="fc" id="L221">        List&lt;Map&lt;String, Object&gt;&gt; dados = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L222" title="All 2 branches covered.">        for (Map.Entry&lt;String, Long&gt; entry : atividadesPorMes.entrySet()) {</span>
<span class="fc" id="L223">            Map&lt;String, Object&gt; item = new HashMap&lt;&gt;();</span>
<span class="fc" id="L224">            item.put(&quot;mes&quot;, entry.getKey());</span>
<span class="fc" id="L225">            item.put(&quot;atividades&quot;, entry.getValue());</span>
<span class="fc" id="L226">            dados.add(item);</span>
<span class="fc" id="L227">        }</span>
        
<span class="fc" id="L229">        resultado.put(KEY_DADOS, dados);</span>
<span class="fc" id="L230">        resultado.put(&quot;totalAtividades&quot;, atividades.size());</span>
<span class="fc" id="L231">        resultado.put(&quot;periodo&quot;, meses + &quot; meses&quot;);</span>
        
<span class="fc" id="L233">        return resultado;</span>
    }

    @GetMapping(&quot;/resumo-executivo&quot;)
    public Map&lt;String, Object&gt; getResumoExecutivo() {
<span class="fc" id="L238">        Map&lt;String, Object&gt; resultado = new HashMap&lt;&gt;();</span>
        
        // Buscar dados gerais
<span class="fc" id="L241">        long totalExpositores = expositorRepository.count();</span>
<span class="fc" id="L242">        long totalOportunidades = oportunidadeRepository.count();</span>
<span class="fc" id="L243">        long totalInteracoes = interacaoRepository.count();</span>
        
        // Calcular valores
<span class="fc" id="L246">        List&lt;com.crmshot.entity.Oportunidade&gt; oportunidades = oportunidadeRepository.findAll();</span>
<span class="fc" id="L247">        BigDecimal valorTotalEstimado = oportunidades.stream()</span>
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">            .map(op -&gt; op.getValorEstimado() != null ? op.getValorEstimado() : BigDecimal.ZERO)</span>
<span class="fc" id="L249">            .reduce(BigDecimal.ZERO, BigDecimal::add);</span>
        
<span class="fc" id="L251">        BigDecimal valorGanho = oportunidades.stream()</span>
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">            .filter(op -&gt; op.getStatus() == com.crmshot.entity.Oportunidade.StatusOportunidade.FECHADA_GANHA)</span>
<span class="pc bnc" id="L253" title="All 2 branches missed.">            .map(op -&gt; op.getValorEstimado() != null ? op.getValorEstimado() : BigDecimal.ZERO)</span>
<span class="fc" id="L254">            .reduce(BigDecimal.ZERO, BigDecimal::add);</span>
        
<span class="fc" id="L256">        BigDecimal valorEmAberto = oportunidades.stream()</span>
<span class="pc bpc" id="L257" title="1 of 2 branches missed.">            .filter(op -&gt; op.getStatus() != com.crmshot.entity.Oportunidade.StatusOportunidade.FECHADA_GANHA &amp;&amp;</span>
<span class="pc bpc" id="L258" title="1 of 2 branches missed.">                         op.getStatus() != com.crmshot.entity.Oportunidade.StatusOportunidade.FECHADA_PERDIDA)</span>
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">            .map(op -&gt; op.getValorEstimado() != null ? op.getValorEstimado() : BigDecimal.ZERO)</span>
<span class="fc" id="L260">            .reduce(BigDecimal.ZERO, BigDecimal::add);</span>
        
<span class="fc" id="L262">        resultado.put(&quot;totalExpositores&quot;, totalExpositores);</span>
<span class="fc" id="L263">        resultado.put(&quot;totalOportunidades&quot;, totalOportunidades);</span>
<span class="fc" id="L264">        resultado.put(&quot;totalInteracoes&quot;, totalInteracoes);</span>
<span class="fc" id="L265">        resultado.put(&quot;valorTotalEstimado&quot;, valorTotalEstimado.doubleValue());</span>
<span class="fc" id="L266">        resultado.put(&quot;valorGanho&quot;, valorGanho.doubleValue());</span>
<span class="fc" id="L267">        resultado.put(&quot;valorEmAberto&quot;, valorEmAberto.doubleValue());</span>
        
<span class="fc" id="L269">        return resultado;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>