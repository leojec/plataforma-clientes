<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AgendaController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">crmshot-backend</a> &gt; <a href="index.source.html" class="el_package">com.crmshot.controller</a> &gt; <span class="el_source">AgendaController.java</span></div><h1>AgendaController.java</h1><pre class="source lang-java linenums">package com.crmshot.controller;

import com.crmshot.entity.Interacao;
import com.crmshot.entity.Expositor;
import com.crmshot.entity.Usuario;
import com.crmshot.repository.InteracaoRepository;
import com.crmshot.repository.ExpositorRepository;
import com.crmshot.repository.UsuarioRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;

@RestController
@RequestMapping(&quot;/api/agenda&quot;)
@CrossOrigin(origins = &quot;*&quot;)
<span class="nc" id="L21">public class AgendaController {</span>

    @Autowired
    private InteracaoRepository interacaoRepository;
    
    @Autowired
    private ExpositorRepository expositorRepository;
    
    @Autowired
    private UsuarioRepository usuarioRepository;

    @GetMapping(&quot;/atividades/lead/{leadId}&quot;)
    public ResponseEntity&lt;List&lt;Map&lt;String, Object&gt;&gt;&gt; getAtividadesPorLead(@PathVariable Long leadId) {
        try {
            // Buscar todas as interações do lead
<span class="nc" id="L36">            List&lt;Interacao&gt; interacoes = interacaoRepository.findByExpositorId(leadId);</span>
            
<span class="nc" id="L38">            List&lt;Map&lt;String, Object&gt;&gt; atividades = new ArrayList&lt;&gt;();</span>
            
            // Converter interações para formato da agenda
<span class="nc bnc" id="L41" title="All 2 branches missed.">            for (Interacao interacao : interacoes) {</span>
<span class="nc" id="L42">                Map&lt;String, Object&gt; atividade = new HashMap&lt;&gt;();</span>
<span class="nc" id="L43">                atividade.put(&quot;id&quot;, interacao.getId());</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">                atividade.put(&quot;data&quot;, interacao.getDataCriacao() != null ? </span>
<span class="nc" id="L45">                    interacao.getDataCriacao().format(DateTimeFormatter.ofPattern(&quot;dd/MM/yyyy&quot;)) : &quot;&quot;);</span>
<span class="nc" id="L46">                atividade.put(&quot;tipo&quot;, mapTipoInteracao(interacao.getTipo()));</span>
<span class="nc" id="L47">                atividade.put(&quot;descricao&quot;, interacao.getDescricao());</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">                atividade.put(&quot;agendamento&quot;, interacao.getDataProximaAcao() != null ? </span>
<span class="nc" id="L49">                    &quot;Sim - &quot; + interacao.getDataProximaAcao().format(DateTimeFormatter.ofPattern(&quot;dd/MM/yyyy&quot;)) : &quot;Não&quot;);</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">                atividade.put(&quot;usuario&quot;, interacao.getUsuario() != null ? interacao.getUsuario().getNome() : &quot;Administrador&quot;);</span>
<span class="nc" id="L51">                atividade.put(&quot;link&quot;, &quot;&quot;); // Campo para links futurosss</span>
<span class="nc" id="L52">                atividades.add(atividade);</span>
            }
            
<span class="nc" id="L55">            return ResponseEntity.ok(atividades);</span>
<span class="nc" id="L56">        } catch (Exception e) {</span>
<span class="nc" id="L57">            System.out.println(&quot;Erro ao buscar atividades do lead: &quot; + e.getMessage());</span>
<span class="nc" id="L58">            e.printStackTrace();</span>
<span class="nc" id="L59">            return ResponseEntity.internalServerError().build();</span>
        }
    }

    @GetMapping(&quot;/atividades&quot;)
    public Map&lt;String, Object&gt; getAtividadesAgenda(
            @RequestParam(required = false) String data,
            @RequestParam(required = false, defaultValue = &quot;dia&quot;) String modo) {
        
<span class="nc" id="L68">        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
        
        // Definir data de consulta
<span class="nc bnc" id="L71" title="All 2 branches missed.">        LocalDate dataConsulta = data != null ? </span>
<span class="nc" id="L72">            LocalDate.parse(data.substring(0, 10)) : LocalDate.now();</span>
        
        // Buscar atividades reais do banco de dados
<span class="nc" id="L75">        LocalDateTime inicioData = dataConsulta.atStartOfDay();</span>
<span class="nc" id="L76">        LocalDateTime fimData = dataConsulta.plusDays(1).atStartOfDay();</span>
        
        // Buscar todas as interações (atividades) do dia usando query otimizada
<span class="nc" id="L79">        List&lt;Interacao&gt; interacoes = interacaoRepository.findByDataProximaAcao(dataConsulta.atStartOfDay());</span>
        
<span class="nc" id="L81">        List&lt;Map&lt;String, Object&gt;&gt; atividades = new ArrayList&lt;&gt;();</span>
        
        // Converter interações para formato da agenda
<span class="nc bnc" id="L84" title="All 2 branches missed.">        for (Interacao interacao : interacoes) {</span>
<span class="nc" id="L85">            Map&lt;String, Object&gt; atividade = new HashMap&lt;&gt;();</span>
<span class="nc" id="L86">            atividade.put(&quot;id&quot;, interacao.getId());</span>
<span class="nc" id="L87">            atividade.put(&quot;titulo&quot;, interacao.getTipo().name() + &quot; - &quot; + </span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">                (interacao.getExpositor() != null ? </span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">                    (interacao.getExpositor().getNomeFantasia() != null ? </span>
<span class="nc" id="L90">                        interacao.getExpositor().getNomeFantasia() : </span>
<span class="nc" id="L91">                        interacao.getExpositor().getRazaoSocial()) : &quot;Lead&quot;));</span>
<span class="nc" id="L92">            atividade.put(&quot;descricao&quot;, interacao.getDescricao());</span>
<span class="nc" id="L93">            atividade.put(&quot;tipo&quot;, mapTipoInteracao(interacao.getTipo()));</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">            atividade.put(&quot;horario&quot;, interacao.getDataProximaAcao() != null ? </span>
<span class="nc" id="L95">                interacao.getDataProximaAcao().format(DateTimeFormatter.ofPattern(&quot;HH:mm&quot;)) : &quot;00:00&quot;);</span>
<span class="nc" id="L96">            atividade.put(&quot;data&quot;, dataConsulta.toString());</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">            atividade.put(&quot;leadNome&quot;, interacao.getExpositor() != null ? </span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">                (interacao.getExpositor().getNomeFantasia() != null ? </span>
<span class="nc" id="L99">                    interacao.getExpositor().getNomeFantasia() : </span>
<span class="nc" id="L100">                    interacao.getExpositor().getRazaoSocial()) : &quot;Lead&quot;);</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">            atividade.put(&quot;leadId&quot;, &quot;lead-&quot; + (interacao.getExpositor() != null ? </span>
<span class="nc" id="L102">                interacao.getExpositor().getId() : &quot;0&quot;));</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">            atividade.put(&quot;status&quot;, interacao.getConcluida() ? &quot;concluida&quot; : &quot;agendada&quot;);</span>
<span class="nc" id="L104">            atividades.add(atividade);</span>
        }
        
        // Não adicionar dados fictícios - mostrar apenas atividades reais cadastradas
        
<span class="nc" id="L109">        response.put(&quot;atividades&quot;, atividades);</span>
<span class="nc" id="L110">        response.put(&quot;total&quot;, atividades.size());</span>
<span class="nc" id="L111">        response.put(&quot;concluidas&quot;, (int) atividades.stream()</span>
<span class="nc" id="L112">            .filter(a -&gt; &quot;concluida&quot;.equals(a.get(&quot;status&quot;)))</span>
<span class="nc" id="L113">            .count());</span>
<span class="nc" id="L114">        response.put(&quot;pendentes&quot;, (int) atividades.stream()</span>
<span class="nc" id="L115">            .filter(a -&gt; &quot;agendada&quot;.equals(a.get(&quot;status&quot;)))</span>
<span class="nc" id="L116">            .count());</span>
        
<span class="nc" id="L118">        return response;</span>
    }
    
    private String mapTipoInteracao(Interacao.TipoInteracao tipo) {
<span class="nc bnc" id="L122" title="All 7 branches missed.">        switch (tipo) {</span>
            case LIGACAO:
<span class="nc" id="L124">                return &quot;Ligação&quot;;</span>
            case EMAIL:
<span class="nc" id="L126">                return &quot;Email&quot;;</span>
            case REUNIAO:
<span class="nc" id="L128">                return &quot;Reunião&quot;;</span>
            case WHATSAPP:
<span class="nc" id="L130">                return &quot;Contato WhatsApp&quot;;</span>
            case PROPOSTA:
<span class="nc" id="L132">                return &quot;Proposta&quot;;</span>
            case FECHADO:
<span class="nc" id="L134">                return &quot;Fechado&quot;;</span>
            default:
<span class="nc" id="L136">                return &quot;Outros&quot;;</span>
        }
    }
    
    @PostMapping(&quot;/atividades&quot;)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; salvarAtividade(@RequestBody Map&lt;String, Object&gt; atividadeData) {
        try {
            // Extrair dados da atividade
<span class="nc" id="L144">            String tipoAtividade = (String) atividadeData.get(&quot;tipoAtividade&quot;);</span>
<span class="nc" id="L145">            String descricao = (String) atividadeData.get(&quot;descricao&quot;);</span>
<span class="nc" id="L146">            String dataAgendamento = (String) atividadeData.get(&quot;dataAgendamento&quot;);</span>
<span class="nc" id="L147">            String horarioAgendamento = (String) atividadeData.get(&quot;horarioAgendamento&quot;);</span>
<span class="nc" id="L148">            String leadId = (String) atividadeData.get(&quot;leadId&quot;);</span>
            
            // Campos específicos de Proposta
<span class="nc" id="L151">            Object valorPropostaObj = atividadeData.get(&quot;valorProposta&quot;);</span>
<span class="nc" id="L152">            Object metrosQuadradosObj = atividadeData.get(&quot;metrosQuadrados&quot;);</span>
            
            // Mapear tipo de atividade
<span class="nc" id="L155">            Interacao.TipoInteracao tipo = mapStringToTipoInteracao(tipoAtividade);</span>
            
            // Buscar expositor (lead)
<span class="nc" id="L158">            Long expositorId = null;</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">            if (leadId != null) {</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">                if (leadId.startsWith(&quot;lead-&quot;)) {</span>
                    try {
<span class="nc" id="L162">                        expositorId = Long.parseLong(leadId.replace(&quot;lead-&quot;, &quot;&quot;));</span>
<span class="nc" id="L163">                    } catch (NumberFormatException e) {</span>
                        // Se não conseguir converter, usar ID 1 como padrão
<span class="nc" id="L165">                        expositorId = 1L;</span>
                    }
<span class="nc" id="L167">                } else {</span>
                    // Se não tem prefixo &quot;lead-&quot;, tentar converter diretamente
                    try {
<span class="nc" id="L170">                        expositorId = Long.parseLong(leadId);</span>
<span class="nc" id="L171">                    } catch (NumberFormatException e) {</span>
<span class="nc" id="L172">                        expositorId = 1L;</span>
                    }
                }
<span class="nc" id="L175">            } else {</span>
<span class="nc" id="L176">                expositorId = 1L;</span>
            }
            
<span class="nc bnc" id="L179" title="All 2 branches missed.">            Optional&lt;Expositor&gt; expositorOpt = expositorRepository.findById(expositorId != null ? expositorId : 1L);</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">            if (!expositorOpt.isPresent()) {</span>
<span class="nc" id="L181">                Map&lt;String, Object&gt; errorResponse = new HashMap&lt;&gt;();</span>
<span class="nc" id="L182">                errorResponse.put(&quot;erro&quot;, &quot;Lead não encontrado&quot;);</span>
<span class="nc" id="L183">                return ResponseEntity.badRequest().body(errorResponse);</span>
            }
            
            // Buscar usuário (usar o primeiro ativo)
<span class="nc" id="L187">            List&lt;Usuario&gt; usuarios = usuarioRepository.findByAtivoTrue();</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">            if (usuarios.isEmpty()) {</span>
<span class="nc" id="L189">                Map&lt;String, Object&gt; errorResponse = new HashMap&lt;&gt;();</span>
<span class="nc" id="L190">                errorResponse.put(&quot;erro&quot;, &quot;Nenhum usuário ativo encontrado&quot;);</span>
<span class="nc" id="L191">                return ResponseEntity.badRequest().body(errorResponse);</span>
            }
            
            // Criar nova interação
<span class="nc" id="L195">            Interacao novaInteracao = new Interacao();</span>
<span class="nc" id="L196">            novaInteracao.setExpositor(expositorOpt.get());</span>
<span class="nc" id="L197">            novaInteracao.setUsuario(usuarios.get(0)); // Usar primeiro usuário ativo</span>
<span class="nc" id="L198">            novaInteracao.setTipo(tipo);</span>
<span class="nc" id="L199">            novaInteracao.setAssunto(tipoAtividade + &quot; - &quot; + </span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">                (expositorOpt.get().getNomeFantasia() != null ? </span>
<span class="nc" id="L201">                    expositorOpt.get().getNomeFantasia() : </span>
<span class="nc" id="L202">                    expositorOpt.get().getRazaoSocial()));</span>
            
            // Se for PROPOSTA ou FECHADO, processar campos específicos
<span class="nc bnc" id="L205" title="All 4 branches missed.">            if (tipo == Interacao.TipoInteracao.PROPOSTA || tipo == Interacao.TipoInteracao.FECHADO) {</span>
                // Processar valor da proposta
<span class="nc bnc" id="L207" title="All 2 branches missed.">                if (valorPropostaObj != null) {</span>
                    try {
<span class="nc" id="L209">                        String valorStr = valorPropostaObj.toString().replace(&quot;,&quot;, &quot;.&quot;);</span>
<span class="nc" id="L210">                        Double valor = Double.parseDouble(valorStr);</span>
<span class="nc" id="L211">                        novaInteracao.setValorProposta(valor);</span>
<span class="nc" id="L212">                    } catch (NumberFormatException e) {</span>
<span class="nc" id="L213">                        novaInteracao.setValorProposta(0.0);</span>
                    }
                }
                
                // Processar metros quadrados
<span class="nc bnc" id="L218" title="All 2 branches missed.">                if (metrosQuadradosObj != null) {</span>
                    try {
<span class="nc" id="L220">                        String metrosStr = metrosQuadradosObj.toString().replace(&quot;,&quot;, &quot;.&quot;);</span>
<span class="nc" id="L221">                        Double metros = Double.parseDouble(metrosStr);</span>
<span class="nc" id="L222">                        novaInteracao.setMetrosQuadrados(metros);</span>
<span class="nc" id="L223">                    } catch (NumberFormatException e) {</span>
<span class="nc" id="L224">                        novaInteracao.setMetrosQuadrados(0.0);</span>
                    }
                }
                
                // Para proposta/fechado, a descrição é opcional, usar valor formatado se não tiver descrição
<span class="nc bnc" id="L229" title="All 4 branches missed.">                if (descricao == null || descricao.isEmpty()) {</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">                    String tipoNome = (tipo == Interacao.TipoInteracao.FECHADO) ? &quot;Negócio fechado&quot; : &quot;Proposta&quot;;</span>
<span class="nc" id="L231">                    descricao = String.format(&quot;%s no valor de R$ %.2f para área de %.2f m²&quot;, </span>
<span class="nc" id="L232">                        tipoNome,</span>
<span class="nc" id="L233">                        novaInteracao.getValorProposta(), </span>
<span class="nc" id="L234">                        novaInteracao.getMetrosQuadrados());</span>
                }
                
                // Se for FECHADO, marcar como concluído automaticamente
<span class="nc bnc" id="L238" title="All 2 branches missed.">                if (tipo == Interacao.TipoInteracao.FECHADO) {</span>
<span class="nc" id="L239">                    novaInteracao.setConcluida(true);</span>
                }
            }
            
<span class="nc bnc" id="L243" title="All 2 branches missed.">            novaInteracao.setDescricao(descricao != null ? descricao : &quot;Sem descrição&quot;);</span>
            
            // Configurar data e horário da próxima ação
<span class="nc bnc" id="L246" title="All 4 branches missed.">            if (dataAgendamento != null &amp;&amp; horarioAgendamento != null) {</span>
                try {
<span class="nc" id="L248">                    LocalDate data = LocalDate.parse(dataAgendamento);</span>
<span class="nc" id="L249">                    String[] horaParts = horarioAgendamento.split(&quot;:&quot;);</span>
<span class="nc" id="L250">                    int hora = Integer.parseInt(horaParts[0]);</span>
<span class="nc" id="L251">                    int minuto = Integer.parseInt(horaParts[1]);</span>
                    
<span class="nc" id="L253">                    LocalDateTime dataProximaAcao = data.atTime(hora, minuto);</span>
<span class="nc" id="L254">                    novaInteracao.setDataProximaAcao(dataProximaAcao);</span>
<span class="nc" id="L255">                } catch (Exception e) {</span>
                    // Se houver erro no parsing, usar data/hora atual + 1 hora
<span class="nc" id="L257">                    novaInteracao.setDataProximaAcao(LocalDateTime.now().plusHours(1));</span>
                }
<span class="nc" id="L259">            } else {</span>
                // Se não informado, agendar para 1 hora à frente
<span class="nc" id="L261">                novaInteracao.setDataProximaAcao(LocalDateTime.now().plusHours(1));</span>
            }
            
            // Salvar no banco
<span class="nc" id="L265">            Interacao atividadeSalva = interacaoRepository.save(novaInteracao);</span>
            
            // Retornar resposta de sucesso
<span class="nc" id="L268">            Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="nc" id="L269">            response.put(&quot;id&quot;, atividadeSalva.getId());</span>
<span class="nc" id="L270">            response.put(&quot;sucesso&quot;, true);</span>
<span class="nc" id="L271">            response.put(&quot;mensagem&quot;, &quot;Atividade salva com sucesso&quot;);</span>
            
<span class="nc" id="L273">            return ResponseEntity.ok(response);</span>
            
<span class="nc" id="L275">        } catch (Exception e) {</span>
<span class="nc" id="L276">            Map&lt;String, Object&gt; errorResponse = new HashMap&lt;&gt;();</span>
<span class="nc" id="L277">            errorResponse.put(&quot;erro&quot;, &quot;Erro ao salvar atividade: &quot; + e.getMessage());</span>
<span class="nc" id="L278">            return ResponseEntity.badRequest().body(errorResponse);</span>
        }
    }
    
    @PutMapping(&quot;/atividades/{id}/concluir&quot;)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; marcarComoConcluida(@PathVariable Long id) {
        try {
<span class="nc" id="L285">            Optional&lt;Interacao&gt; interacaoOpt = interacaoRepository.findById(id);</span>
            
<span class="nc bnc" id="L287" title="All 2 branches missed.">            if (!interacaoOpt.isPresent()) {</span>
<span class="nc" id="L288">                Map&lt;String, Object&gt; errorResponse = new HashMap&lt;&gt;();</span>
<span class="nc" id="L289">                errorResponse.put(&quot;sucesso&quot;, false);</span>
<span class="nc" id="L290">                errorResponse.put(&quot;mensagem&quot;, &quot;Atividade não encontrada&quot;);</span>
<span class="nc" id="L291">                return ResponseEntity.notFound().build();</span>
            }
            
<span class="nc" id="L294">            Interacao interacao = interacaoOpt.get();</span>
<span class="nc" id="L295">            interacao.setConcluida(true);</span>
<span class="nc" id="L296">            interacao.setDataAtualizacao(LocalDateTime.now());</span>
            
<span class="nc" id="L298">            interacaoRepository.save(interacao);</span>
            
<span class="nc" id="L300">            Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="nc" id="L301">            response.put(&quot;sucesso&quot;, true);</span>
<span class="nc" id="L302">            response.put(&quot;mensagem&quot;, &quot;Atividade marcada como concluída&quot;);</span>
<span class="nc" id="L303">            response.put(&quot;id&quot;, id);</span>
            
<span class="nc" id="L305">            return ResponseEntity.ok(response);</span>
<span class="nc" id="L306">        } catch (Exception e) {</span>
<span class="nc" id="L307">            Map&lt;String, Object&gt; errorResponse = new HashMap&lt;&gt;();</span>
<span class="nc" id="L308">            errorResponse.put(&quot;sucesso&quot;, false);</span>
<span class="nc" id="L309">            errorResponse.put(&quot;mensagem&quot;, &quot;Erro ao marcar atividade como concluída: &quot; + e.getMessage());</span>
<span class="nc" id="L310">            return ResponseEntity.badRequest().body(errorResponse);</span>
        }
    }

    private Interacao.TipoInteracao mapStringToTipoInteracao(String tipo) {
<span class="nc bnc" id="L315" title="All 7 branches missed.">        switch (tipo) {</span>
            case &quot;Ligação&quot;:
<span class="nc" id="L317">                return Interacao.TipoInteracao.LIGACAO;</span>
            case &quot;Email&quot;:
<span class="nc" id="L319">                return Interacao.TipoInteracao.EMAIL;</span>
            case &quot;Reunião&quot;:
<span class="nc" id="L321">                return Interacao.TipoInteracao.REUNIAO;</span>
            case &quot;Contato WhatsApp&quot;:
<span class="nc" id="L323">                return Interacao.TipoInteracao.WHATSAPP;</span>
            case &quot;Proposta&quot;:
<span class="nc" id="L325">                return Interacao.TipoInteracao.PROPOSTA;</span>
            case &quot;Fechado&quot;:
<span class="nc" id="L327">                return Interacao.TipoInteracao.FECHADO;</span>
            default:
<span class="nc" id="L329">                return Interacao.TipoInteracao.OUTROS;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>